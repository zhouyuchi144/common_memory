
# 任务：
用pyspark实现：
输入的【历史会话】数据中，提取【家的地址】和【公司地址】

# 要求：
1、输入的【历史会话】数据中，使用的字段和规则
- role：user是user，bot是assistant
- msg：user和assistant的会话内容。
  提取地址特征时，msg分多次请求大模型（每次最多请求用1000个msg）
- id：从小到大进行排序，作为msg的先后依据
- 需要根据字段msg_type进行数据过滤（只取`msg_type=must`的数据）



# 输入：【历史会话】数据
- 数据存储的HDFS路径：/data/chat_hist/partition_date=2025-09-05/
- 数据示例：
user_id,msg,msg_type,ts,intent_id,conversation_id,req_id,talk_cmd,mic_cmd,scene_id,msg_modal,role,topic,id,scene_sub_id,audio_blob_id,audio_blob_url
1945410264316772352,稍等哈,padding,1757001600162,10007,356ffbec-9f12-4a22-b1d6-2a8499719537_1757001549218,1945410264316772352---2687,on,off,-1,text,bot,"",63473,-1,be09b9d5-adb2-4a0c-a0fa-3f972e3cd684,""
1945410264316772352,好的，从方正大厦东南门到云趣园三区5号楼342，快车费用是39.13元，可以吗？,must,1757001600510,10007,356ffbec-9f12-4a22-b1d6-2a8499719537_1757001549218,1945410264316772352---2687,on,on,-1,text,bot,"",63474,-1,8e474d5b-d046-44e4-9785-63845012f178,""

# 输出：
- 数据示例：
user_id,home_address,company_address
1945410264316772352,方正大厦东南门,云趣园三区5号楼342


# 访问大模型的函数
def llm_interface(messages):
    url = 'http://172.16.1.151:8000/v1/chat/completions'
    headers = {"Content-Type": "application/json"}
    params = {
        "model": "/data/model/qwen3-14b",
        "messages": messages,
        "temperature": 0.6, "stream": False, "chat_template_kwargs": {"enable_thinking": False}
    }
    try:
        resp = requests.post(url, json=params, headers=headers)
        output_data = resp.json()
        return output_data['choices'][0]['message']['content']
    except Exception as e:
        return ""


# 请求大模型的system prompt
system_prompt = """# 任务
你是一个地址信息提取助手。请从用户的多轮对话中识别并提取家庭地址和公司地址。

# 要求：
家庭地址(home)和公司地址(comp)：完整地包含地址的全部细节
例如：菊园2号楼4单元301

# 输出
必须是严格的JSON格式，确保格式正确，不要增加任何字符
如果没有提取到某个地址，将其值设为空字符串。
示例输出：{"home": "菊园2号楼4单元301", "comp": "方正大厦东南门"}"""
